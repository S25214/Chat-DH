<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DigitalHuman Widget Documentation</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
        }

        h1,
        h2,
        h3 {
            color: #2c3e50;
        }

        h1 {
            border-bottom: 2px solid #eaeaea;
            padding-bottom: 10px;
        }

        h2 {
            margin-top: 30px;
            border-bottom: 1px solid #eaeaea;
            padding-bottom: 5px;
        }

        code {
            background-color: #eef;
            padding: 2px 4px;
            border-radius: 4px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 0.9em;
        }

        pre {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
        }

        pre code {
            background-color: transparent;
            color: inherit;
            padding: 0;
        }

        .note {
            background-color: #e8f4fd;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 4px 4px 0;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }
    </style>
</head>

<body>

    <h1>DigitalHuman Widget Documentation</h1>
    <p>This guide explains how to install, initialize, and control the DigitalHuman Widget, as well as how to set up
        your
        backend TTS (Text-to-Speech) API to work with the widget.
    <ul>
        <li>Example page: <a href="index_example.html">index_example.html</a></li>
        <li>Custom container page: <a href="index_custom_container.html">index_custom_container.html</a></li>
        <li>TTS API example (Firebase cloud function): <a href="tts_api_example.ts">tts_api_example.ts</a></li>
    </ul>
    </p>


    <h2>1. Installation</h2>
    <p>To use the widget, include the <code>digitalhuman-widget.js</code> script in your HTML file. You can use the
        local file or load it from our CDN.</p>

    <h3>Option 1: Local File</h3>
    <pre><code>&lt;script src="digitalhuman-widget.js"&gt;&lt;/script&gt;</code></pre>

    <h3>Option 2: CDN (Recommended)</h3>
    <pre><code>&lt;script src="https://dhchat.didthat.cc/DigitalHuman/digitalhuman-widget.js"&gt;&lt;/script&gt;</code></pre>

    <h2>2. Initialization</h2>
    <p>Initialize the widget using the global <code>DigitalHuman.init</code> method. This should be called after the
        script has loaded.</p>

    <h3>Basic Usage</h3>
    <pre><code>// Initialize with the App ID (previously Stream ID)
window.DigitalHuman.init("YOUR_APP_ID"); // e.g., "6744fb98094f..."</code></pre>

    <h3>Advanced Usage (with Options)</h3>
    <pre><code>window.DigitalHuman.init("YOUR_APP_ID", {
    autoUnmute: false, // Default: false. Attempts to unmute automatically.
    showUI: true,      // Default: true. Set to false to hide the UI on init.
    container: document.getElementById('my-custom-container'), // Optional: DOM element to render inside
    lookAt: true,       // Default: false. If true, enables face detection (via webcam) to control the idle look-at behavior.
    microphone: true    // Default: true. Set to false to disable microphone access for the stream.
});</code></pre>

    <h3>Example: Programmatic Container Creation</h3>
    <p>You can also create the container element directly in your JavaScript code:</p>
    <pre><code>// 1. Create the container
const myContainer = document.createElement('div');
myContainer.style.width = "400px";
myContainer.style.height = "600px";
myContainer.style.border = "2px solid #333";
document.body.appendChild(myContainer);

// 2. Initialize the widget into the new container
window.DigitalHuman.init("YOUR_APP_ID", {
    container: myContainer
});</code></pre>

    <div class="note">
        <strong>Note:</strong> If no <code>container</code> is provided, the widget will create its own fixed-position
        container at the bottom-right of the screen.
    </div>

    <h2>3. Widget Methods</h2>
    <p>Once initialized, you can control the widget using the following methods under <code>window.DigitalHuman</code>.
    </p>

    <h3><code>disconnect()</code></h3>
    <p>Removes the widget from the DOM and cleans up event listeners and stream connections.</p>
    <pre><code>window.DigitalHuman.disconnect();</code></pre>

    <h3><code>lookAt(faces, x, y)</code></h3>
    <p>Directs the digital human's gaze. Coordinates are normalized (0.0 to 1.0).</p>
    <ul>
        <li><strong>faces</strong> (number): Number of faces detected (usually 0 or 1).</li>
        <li><strong>x</strong> (number): Horizontal position (0.0 = left, 1.0 = right).</li>
        <li><strong>y</strong> (number): Vertical position (0.0 = top, 1.0 = bottom).</li>
    </ul>
    <pre><code>// Look at center
window.DigitalHuman.lookAt(1, 0.5, 0.5);</code></pre>

    <h3><code>sendMessage(message)</code></h3>
    <p>Sends a generic message command to the pixel streaming instance.</p>
    <pre><code>// Unmute the stream audio
window.DigitalHuman.sendMessage("unMuteAudio");

// Other generic commands
window.DigitalHuman.sendMessage("uiOn");
window.DigitalHuman.sendMessage("uiOff");</code></pre>

    <h3><code>setConfigID(configId)</code></h3>
    <p>Sets the active configuration ID for the digital human.</p>
    <pre><code>window.DigitalHuman.setConfigID("my_config_v1");</code></pre>

    <h3><code>sendJob(text, callbackUrl, authToken, customParams)</code></h3>
    <p>Sends a TTS job request. This tells the widget to send a payload to your backend/callback URL.</p>
    <ul>
        <li><strong>text</strong> (string): The text to be spoken.</li>
        <li><strong>callbackUrl</strong> (string): The URL of your TTS API endpoint.</li>
        <li><strong>authToken</strong> (string, optional): Authorization token (e.g., Bearer token).</li>
        <li><strong>customParams</strong> (object, optional): Additional parameters to pass to your API.</li>
    </ul>

    <pre><code>const customParams = {
    provider: "google",
    language: "en-US", 
    speaker: "en-US-Wavenet-D"
};

window.DigitalHuman.sendJob(
    "Hello, world!", 
    "https://your-api.com/tts", 
    "YOUR_AUTH_TOKEN", 
    customParams
);</code></pre>

    <h2>4. TTS API Setup Guide</h2>
    <p>When you use <code>sendJob</code>, the widget sends a POST request to your specified <code>callbackUrl</code>.
        Your API must be set up to handle this request and return the audio data in a specific format.</p>

    <h3>Request Format</h3>
    <p>The widget will send a JSON payload via POST. The structure is flexible, but <code>text</code> is always
        included.</p>

    <pre><code>POST /your-tts-endpoint
Content-Type: application/json
Authorization: Bearer YOUR_AUTH_TOKEN

{
  "command": "tts_order",
  "text": "Hello, world!",
  "auth_token": "YOUR_AUTH_TOKEN",
  "callback_url": "...",
  "provider": "google",       // From customParams
  "language": "en-US",        // From customParams
  "speaker": "en-US-Wavenet-D" // From customParams
}</code></pre>

    <div class="note">
        <strong>Rule:</strong> Only the <code>text</code> field is mandatory for the widget's internal logic. All fields
        from <code>customParams</code> are merged into the root of this JSON object. You can design your API to require
        whatever parameters you need (e.g., <code>provider</code>, <code>voice_id</code>, etc.).
    </div>

    <h3>Response Format (Critical)</h3>
    <p>Your API <strong>must</strong> return a JSON object containing the audio data as a <strong>Base64 encoded
            string</strong> in a field named <code>content</code>.</p>

    <pre><code>200 OK
Content-Type: application/json

{
  "content": "UklGRi..." // Base64 encoded WAV/MP3 audio data
}</code></pre>

    <h3>Example API Logic (Node.js/TypeScript)</h3>
    <p>Here is a simplified example of how your endpoint might look (based on <code>tts.ts</code>):</p>

    <pre><code>export const tts = onRequest(async (req, res) => {
  // 1. Extract parameters
  const { text, ...otherParams } = req.body;

  if (!text) {
    res.status(400).send({ error: "Missing text" });
    return;
  }

  // 2. Generate Audio (Pseudo-code)
  // You can use otherParams.provider, otherParams.speaker, etc.
  const audioBuffer = await myTTSGenerator(text, otherParams);

  // 3. Convert to Base64
  const audioBase64 = audioBuffer.toString('base64');

  // 4. Return correct format
  res.send({ content: audioBase64 });
});</code></pre>

    <!-- ... (previous content) ... -->

    <h2>5. Interactive API Tester</h2>
    <p>Use this tool to test your TTS API endpoint directly from the browser. This mimics the request that the
        DigitalHuman
        widget sends to your backend. </p>
    <div class="note">
        <strong>Note:</strong> Your API must support <strong>CORS</strong> (Cross-Origin Resource Sharing) for this
        browser-based test to work. If you see "Network Error" or similar, check your CORS settings.
    </div>

    <div style="background: #fff; padding: 20px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 40px;">
        <!-- Inputs -->
        <div style="margin-bottom: 15px;">
            <label style="display:block; margin-bottom:5px; font-weight:600;">TTS Text</label>
            <input type="text" id="testText" value="Hello from DigitalHuman Docs!"
                style="width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px;">
        </div>
        <div style="margin-bottom: 15px;">
            <label style="display:block; margin-bottom:5px; font-weight:600;">API Endpoint (Callback URL)</label>
            <input type="text" id="testUrl" placeholder="https://your-api.com/tts"
                style="width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px;">
        </div>
        <div style="margin-bottom: 15px;">
            <label style="display:block; margin-bottom:5px; font-weight:600;">Auth Token (Optional)</label>
            <input type="text" id="testToken" placeholder="Bearer eyJhbGci..."
                style="width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px;">
        </div>
        <div style="margin-bottom: 15px;">
            <label style="display:block; margin-bottom:5px; font-weight:600;">Custom Params (JSON) (Optional)</label>
            <textarea id="testParams" rows="5"
                style="width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-family: monospace;">{
    "provider": "google",
    "language": "en-US",
    "speaker": "en-US-Wavenet-D"
}</textarea>
        </div>

        <button onclick="runApiTest()"
            style="background: #3498db; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: 600;">Send
            Request & Play Audio</button>

        <div style="margin-top: 20px;">
            <strong>Request Body:</strong>
            <pre id="requestBodyDisplay"
                style="background:#2d2d2d; padding:10px; border-radius:4px; margin-top:5px; max-height:200px; overflow:auto; font-size: 0.9em;">(Waiting for request...)</pre>
        </div>

        <div style="margin-top: 20px;">
            <strong>Response Body:</strong>
            <pre id="responseBodyDisplay"
                style="background:#2d2d2d; padding:10px; border-radius:4px; margin-top:5px; max-height:200px; overflow:auto; font-size: 0.9em;">(Waiting for response...)</pre>
        </div>

        <div id="testStatus" style="margin-top: 20px; padding: 15px; border-radius: 4px; display: none;"></div>
        <audio id="testAudio" controls style="display:none; margin-top:15px; width: 100%;"></audio>
    </div>

    <script>
        async function runApiTest() {
            const text = document.getElementById('testText').value;
            const url = document.getElementById('testUrl').value.trim();
            const token = document.getElementById('testToken').value.trim();
            const paramsStr = document.getElementById('testParams').value;
            const statusDiv = document.getElementById('testStatus');
            const audioPlayer = document.getElementById('testAudio');
            const requestDisplay = document.getElementById('requestBodyDisplay');
            const responseDisplay = document.getElementById('responseBodyDisplay');

            // Reset UI
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#e8f4fd';
            statusDiv.innerText = 'Sending request...';
            statusDiv.style.color = '#333';
            audioPlayer.style.display = 'none';
            audioPlayer.pause();
            audioPlayer.src = "";
            requestDisplay.textContent = "(Serving request...)";
            responseDisplay.textContent = "(Waiting for response...)";

            // Validation
            if (!url) {
                statusDiv.innerText = 'Error: Please enter an API Endpoint URL.';
                statusDiv.style.background = '#fadbd8';
                statusDiv.style.color = '#c0392b';
                return;
            }

            let customParams = {};
            try {
                if (paramsStr.trim()) {
                    customParams = JSON.parse(paramsStr);
                }
            } catch (e) {
                statusDiv.innerText = 'Error: Invalid JSON in Custom Params.';
                statusDiv.style.background = '#fadbd8';
                statusDiv.style.color = '#c0392b';
                return;
            }

            // Construct Payload
            // Strip out auth_token, callback_url and command per user request
            const payload = {
                text: text,
                ...customParams
            };

            // Explicitly remove these if they somehow crept in via customParams
            delete payload.auth_token;
            delete payload.callback_url;
            delete payload.command;

            // Display Request JSON
            requestDisplay.textContent = JSON.stringify(payload, null, 2);

            try {
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (token) {
                    headers['Authorization'] = token;
                }

                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API returned ${response.status}: ${errorText.substring(0, 100)}`);
                }

                const data = await response.json();

                // Display Response JSON
                responseDisplay.textContent = JSON.stringify(data, null, 2);

                if (data.content) {
                    statusDiv.innerText = 'Success! Response received. Playing audio...';
                    statusDiv.style.background = '#d4efdf';
                    statusDiv.style.color = '#1e8449';

                    // Handle Base64 Audio
                    let base64Audio = data.content;
                    // Check if it already has the data URI prefix
                    if (!base64Audio.startsWith('data:audio')) {
                        // Assume WAV or MP3 - browsers are generally smart enough to sniff it if we give a hint, 
                        // but sticking to a safe default like wav is okay, or just `data:audio/wav;base64,`
                        // Most TTS returns generic binary.
                        base64Audio = 'data:audio/wav;base64,' + base64Audio;
                    }

                    audioPlayer.src = base64Audio;
                    audioPlayer.style.display = 'block';
                    audioPlayer.play().catch(e => {
                        console.error("Auto-play failed:", e);
                        statusDiv.innerText += " (Auto-play blocked, please click play)";
                    });
                } else {
                    statusDiv.innerText = 'Response received, but no "content" field found in JSON.';
                    statusDiv.style.background = '#fdebd0';
                    statusDiv.style.color = '#b9770e';
                    console.log("Full Response:", data);
                }

            } catch (err) {
                console.error(err);
                statusDiv.innerText = 'Error: ' + err.message;
                statusDiv.style.background = '#fadbd8';
                statusDiv.style.color = '#c0392b';
            }
        }
    </script>
</body>

</html>